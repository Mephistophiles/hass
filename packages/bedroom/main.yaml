bedroom:
  climate:
    - platform: miheater
      host: 192.168.3.94
      token: !secret miheater_token
      name: xiaomi_heater
      model: zhimi.heater.mc2
  homeassistant:
    customize:
      light.bedroom:
        friendly_name: Bedroom Light
        icon: mdi:ceiling-light
      climate.zhimi_heater_mc2_54_48_e6_78_e3_06:
        friendly_name: Heater
      switch.0xa4c138baeec84dc4:
        friendly_name: PC Table
      switch.0xa4c138a4476e3b34:
        friendly_name: Air Humidifier
      binary_sensor.0x54ef4410005454e4_motion:
        friendly_name: Motion in Bedroom
      camera.camera_hub_g2h_3630_camera_stream_management0:
        friendly_name: Parking Camera

  mqtt:
    sensor:
      - name: Temperature
        state_topic: "sensors/temperature"
        unit_of_measurement: "°C"
        unique_id: bedroom_temperature
        value_template: "{{value | round(2) }}"
        device_class: temperature
      - name: Humidity
        state_topic: "sensors/humidity"
        unit_of_measurement: "%"
        unique_id: "bedroom_humidity"
        device_class: "humidity"
        value_template: "{{value | round(2) }}"
      - name: Air Pressure
        state_topic: "sensors/pressure"
        unit_of_measurement: "hPa"
        unique_id: "air_pressure"
        device_class: pressure
      - name: CO₂
        state_topic: "sensors/co2"
        unit_of_measurement: "PPM"
        class: carbon_dioxide
        icon: mdi:molecule-co2
        unique_id: "co2"
      - name: PM 2.5
        state_topic: "sensors/pm2_5"
        unit_of_measurement: "PPM"
        unique_id: "pm25"
        class: pm25
        icon: mdi:thought-bubble-outline
      - name: PM 10
        state_topic: "sensors/pm10"
        unit_of_measurement: "PPM"
        unique_id: "pm10"
        class: pm10
        icon: mdi:thought-bubble

  input_select:
    bedroom_light:
      name: Bedroom Light Mode
      options:
        - "AUTO"
        - "ON"
        - "OFF"
      initial: AUTO
      icon: mdi:lightbulb

  template:
    - binary_sensor:
        - name: 0x54ef4410005454e4_motion
          state: >
            {{ is_state('binary_sensor.0x54ef4410005454e4_presence', 'on') or
              states('sensor.0x54ef4410005454e4_presence_event') not in ['leave', 'unavailable', 'unknown']
            }}
        - name: 0x54ef4410005454e4_need_light
          state: >
            {{
              is_state('binary_sensor.0x54ef4410005454e4_motion', 'on')
              and is_state('binary_sensor.need_light', 'on')
            }}

  input_boolean:
    bedroom_light_managed:
      name: Light managed by Bedroom sensor

  automation:
    - alias: light_change_mode_to_on
      trigger:
        - platform: state
          entity_id:
            - input_select.bedroom_light
          to: "ON"
      action:
        - service: light.turn_on
          entity_id: light.bedroom
        - service: input_boolean.turn_off
          entity_id: input_boolean.bedroom_light_managed
    - alias: light_change_mode_to_off
      trigger:
        - platform: state
          entity_id:
            - input_select.bedroom_light
          to: "OFF"
      action:
        - service: light.turn_off
          entity_id: light.bedroom
        - service: input_boolean.turn_off
          entity_id: input_boolean.bedroom_light_managed
    - alias: light_change_mode_to_auto_with_presence
      trigger:
        - platform: state
          entity_id:
            - input_select.bedroom_light
          to: "AUTO"
      condition:
        - condition: state
          entity_id: binary_sensor.0x54ef4410005454e4_need_light
          state: "on"
      action:
        - service: light.turn_on
          entity_id: light.bedroom
        - service: input_boolean.turn_on
          entity_id: input_boolean.bedroom_light_managed

    - alias: light_change_mode_to_auto_wo_presence
      trigger:
        - platform: state
          entity_id:
            - input_select.bedroom_light
          to: "AUTO"
      condition:
        - condition: state
          entity_id: binary_sensor.0x54ef4410005454e4_need_light
          state: "off"
      action:
        - service: light.turn_off
          entity_id: light.bedroom
        - service: input_boolean.turn_off
          entity_id: input_boolean.bedroom_light_managed

    - alias: cr_bedroom_ceiling_light_auto_on
      description: Спальня - включение по датчику движения
      trigger:
        - platform: state
          entity_id:
            - binary_sensor.0x54ef4410005454e4_need_light
          to: "on"
      condition:
        - condition: and
          conditions:
            - condition: state
              entity_id: light.bedroom
              state: "off"
            - condition: state
              entity_id: input_select.bedroom_light
              state: "AUTO"

      action:
        - service: light.turn_on
          entity_id: light.bedroom
        - service: input_boolean.turn_on
          entity_id: input_boolean.bedroom_light_managed

    - alias: cr_beedroom_ceiling_light_auto_off
      description: Спальня - отключение по датчику движения
      trigger:
        - platform: state
          entity_id:
            - binary_sensor.0x54ef4410005454e4_need_light
          to: "off"
          for:
            hours: 0
            minutes: 0
            seconds: 5
      condition:
        - condition: state
          entity_id: input_boolean.bedroom_light_managed
          state: "on"
      action:
        - service: light.turn_off
          entity_id: light.bedroom
        - service: input_boolean.turn_off
          entity_id: input_boolean.bedroom_light_managed
