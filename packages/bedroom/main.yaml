bedroom:
  climate:
    - platform: miheater
      host: 192.168.3.94
      token: !secret miheater_token
      name: xiaomi_heater
      model: zhimi.heater.mc2
  homeassistant:
    customize:
      light.bedroom:
        friendly_name: Bedroom Light
        icon: mdi:ceiling-light
      climate.zhimi_heater_mc2_54_48_e6_78_e3_06:
        friendly_name: Heater
      switch.0xa4c138baeec84dc4:
        friendly_name: PC Table
      switch.0xa4c138a4476e3b34:
        friendly_name: Air Humidifier
      binary_sensor.bedroom_presence:
        friendly_name: Presence in Bedroom
      camera.camera_hub_g2h_3630_camera_stream_management0:
        friendly_name: Parking Camera
      binary_sensor.0x70ac08fffe99724d_presence:
        friendly_name: Presence in Bedroom, sensor 2
      sensor.0x04cf8cdf3c8dd15b_illuminance_lux:
        friendly_name: Illuminance in Bedroom

  mqtt:
    sensor:
      - name: Temperature
        state_topic: "sensors/temperature"
        unit_of_measurement: "°C"
        unique_id: bedroom_temperature
        value_template: "{{value | round(2) }}"
        device_class: temperature
      - name: Humidity
        state_topic: "sensors/humidity"
        unit_of_measurement: "%"
        unique_id: "bedroom_humidity"
        device_class: "humidity"
        value_template: "{{value | round(2) }}"
      - name: Air Pressure
        state_topic: "sensors/pressure"
        unit_of_measurement: "hPa"
        unique_id: "air_pressure"
        device_class: pressure
      - name: CO₂
        state_topic: "sensors/co2"
        unit_of_measurement: "PPM"
        device_class: carbon_dioxide
        icon: mdi:molecule-co2
        unique_id: "co2"
      - name: PM 2.5
        state_topic: "sensors/pm2_5"
        unit_of_measurement: "PPM"
        unique_id: "pm25"
        device_class: pm25
        icon: mdi:thought-bubble-outline
      - name: PM 10
        state_topic: "sensors/pm10"
        unit_of_measurement: "PPM"
        unique_id: "pm10"
        device_class: pm10
        icon: mdi:thought-bubble

  template:
    - binary_sensor:
        - name: bedroom_presence
          device_class: presence
          state: >
            {{
              (is_state('binary_sensor.0x54ef4410005454e4_presence', 'on') or states('sensor.0x54ef4410005454e4_presence_event') not in ['leave', 'unavailable', 'unknown'])
               or is_state('binary_sensor.0xa4c138638ca68c94_occupancy', 'on')
               or is_state('binary_sensor.0x70ac08fffe99724d_presence', 'on')
            }}
        - name: bedroom_need_light
          state: >
            {{
              is_state('binary_sensor.bedroom_presence', 'on')
              and is_state('input_boolean.need_light', 'on')
            }}
          delay_off: 00:00:30

  input_boolean:
    bedroom_manual_mode:
      name: Bedroom Manual Light Mode
      icon: mdi:lightbulb
    bedroom_light_managed:
      name: Light managed by Bedroom sensor

  automation:
    - id: illuminance_change_light
      alias: illuminance_change_light
      trigger:
        - platform: numeric_state
          entity_id: sensor.0x04cf8cdf3c8dd15b_illuminance_lux
          above: input_number.maximum_illuminance
      action:
        - service: input_boolean.turn_off
          entity_id: input_boolean.need_light
    - id: illuminance_change_dark
      alias: illuminance_change_dark
      trigger:
        - platform: numeric_state
          entity_id: sensor.0x04cf8cdf3c8dd15b_illuminance_lux
          below: input_number.minimal_illuminance
      action:
        - service: input_boolean.turn_on
          entity_id: input_boolean.need_light

    - id: bedroom_light_mode_changed_to_manual
      alias: bedroom_light_mode_changed_to_manual
      trigger:
        - platform: state
          entity_id: input_boolean.bedroom_manual_mode
          to: "on"
      action:
        - service: input_boolean.turn_off
          entity_id: input_boolean.bedroom_light_managed
    - id: bedroom_light_mode_changed_to_auto
      alias: bedroom_light_mode_changed_to_auto
      trigger:
        - platform: state
          entity_id: input_boolean.bedroom_manual_mode
          to: "off"
      action:
        - choose:
          - conditions:
            - condition: state
              entity_id: binary_sensor.bedroom_need_light
              state: "off"
            sequence:
              - service: light.turn_off
                entity_id: light.bedroom
              - service: input_boolean.turn_off
                entity_id: input_boolean.bedroom_light_managed
          - conditions:
            - condition: state
              entity_id: binary_sensor.bedroom_need_light
              state: "on"
            sequence:
              - service: light.turn_on
                entity_id: light.bedroom
              - service: input_boolean.turn_on
                entity_id: input_boolean.bedroom_light_managed
    - id: bedroom_presence_detected
      alias: bedroom_presence_detected
      description: Bedroom - presence detected
      trigger:
        - platform: state
          entity_id:
            - binary_sensor.bedroom_need_light
          to: "on"
      condition:
        - condition: and
          conditions:
            - condition: state
              entity_id: light.bedroom
              state: "off"
            - condition: state
              entity_id: input_boolean.bedroom_manual_mode
              state: "off"

      action:
        - service: light.turn_on
          entity_id: light.bedroom
        - service: input_boolean.turn_on
          entity_id: input_boolean.bedroom_light_managed

    - id: bedroom_presence_clear
      alias: bedroom_presence_clear
      description: Bedroom - presence not detected
      trigger:
        - platform: state
          entity_id: binary_sensor.bedroom_need_light
          to: "off"
        - platform: state
          entity_id: binary_sensor.bedroom_presence
          to: "off"
      action:
        - service: light.turn_off
          entity_id: light.bedroom
        - service: input_boolean.turn_off
          entity_id: input_boolean.bedroom_light_managed
    - id: bedroom_minute_without_presence
      alias: bedroom_minute_without_presence
      description: Bedroom - scheduled check for presence
      trigger:
        - minutes: '*'
          platform: time_pattern
      condition:
        - condition: state
          entity_id: binary_sensor.bedroom_presence
          state: "off"
      action:
        - service: light.turn_off
          entity_id: light.bedroom
        - service: input_boolean.turn_off
          entity_id: input_boolean.bedroom_light_managed
